<link href="https://s3.amazonaws.com/mturk-public/bs30/css/bootstrap.css" media="screen" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<style type="text/css">
#content {
    margin-bottom: 15px;
    padding: 10px 10px;
    font-family: Verdana, Geneva, sans-serif;
    color: #333333;
    font-size: 0.9em;
}

.header-toggle {
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.class1{
    color: #e05151;
}

.class2{
    color: #e9b0b0;
}

.class3{
    color:#a3c0a9;
}

.class4{
    color: #4faf62;
}

p {
    padding: 10px;
    margin: 0;
}

p.yellow {
    font-size: 2em;
    border: 1px solid #ccc;
    border-radius: 3px;
    margin-bottom: 21px;
}

p.yellow span {
    background: orange;
    cursor: pointer;
}

p.yellow::selection {
    color: black;
    background: lightblue;
}

p.yellow::-moz-selection { /* Code for Firefox */
    color: black;
    background: lightblue;
}


#question-hint {
    display: none;
}

.answers-select {
    display: none;
}

.x-button {
    color: red;
    background: white;
    border: 1px solid black;
    border-radius: 50%;
    margin: 0 10px;
    cursor: pointer;
    padding: 1px 6px;
}


.flex {
    display: flex;
    width: 100%;
}

.flex > input {
    width: 100%;
}

.comment{
    float: right;
    width: 30%;
}


.discard{
    float: right;
    display: flex;
    color: lightblue;
}

.body{
    float:left;
    width:40%;
}

#skip, #another-question {
    float: right;
}

.another-question{
    float: right;
}

.panel-primary > .panel-heading {
color: #ffffff;
background-color: #ca427e;
border-color: #ea2279;
}

.panel-primary {
border-color: #df2d75;
}

.panel-info > .panel-heading {
color: #ffffff;
background-color: #7b96e4;
border-color: #bce8f1;
}

#all-answers {
    display: none;
    border-color: none;
}

:focus{
    outline: none;
}

html,body {padding:0;margin:0;}
.wrap {
  float:right;
  font:12px Arial, san-serif;
  width: 50%
}
h1.likert-header {
  padding-left:4.25%;
  margin:20px 0 0;
}
form .statement {
  display:block;
  font-size: 14px;
  font-weight: bold;
  padding: 40px 0 0 8%;
  margin-bottom:10px;
}
form .likert {
  list-style:none;
  width:85%;
  margin-right:40;
  padding:0 0 35px;
  display:block;
  border-bottom:2px solid #efefef;
}
form .likert:last-of-type {border-bottom:0;}
form .likert:before {
  content: '';
  position:relative;
  top:11px;
  left:9.5%;
  display:block;
  background-color:#efefef;
  height:4px;
  width:60%;
}
form .likert li {
  display:inline-block;
  width:19%;
  text-align:center;
  vertical-align: top;
}
form .likert li input[type=radio] {
  display:block;
  position:relative;
  top:0;
  left:50%;
  margin-left:-6px;
  
}
form .likert li label {width:100%;}
form .buttons {
  margin:30px 0;
  padding:0 4.25%;
  padding-top: 40px;
  text-align:right;
  float: right;
  padding-right: 50px;
} 
form .buttons button {
  padding: 5px 10px;
  background-color: #67ab49;
  border: 0;
  border-radius: 3px;
}
form .buttons input {
  padding: 5px 10px;
  background-color: #67ab49;
  border: 0;
  border-radius: 3px;
}
form .buttons .clear {background-color: #e9e9e9;}
form .buttons .submit {background-color: #67ab49;} 
form .buttons .clear:hover {background-color: #ccc;}
form .buttons .submit:hover {background-color: #14892c;} 
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<section class="container" id="content">
    <div class="row col-xs-12 col-md-12">

        <p class="yellow" id="text">$sentence$</p>

    
        <form id="main-form" action="/action_page.php">
            <input id="all-answers" name="answers" type="hidden" value="" />
            <crowd-form>
            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingOne">
                        <h4 class="panel-title">For each QA, decide to what extent it sounds good. If 2 QAs convey the same meaning, mark one of them as redundant.</h4>
                    </div>
                    <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel"
                         aria-labelledby="headingOne">
                         <div class="panel-body" id="q1">
                             <div class="wrap" id="wrap"></div>
                             <!-- <div class="buttons">
                                <button class="clear">Clear</button>
                                <button class="clear">Clear</button>
                                </div> -->
                            <!-- <div class="comment">
                                <br>
                                <br>
                                <br>
                                <label for="comment-1">Would you like to add a comment?</label>&nbsp;<br/>
                                <textarea class="form-control" cols="20" id="comment-1" maxlength="250" name="comment-1" rows="6"></textarea>
                            </div> -->
                            <div id="body" class="body">
                                <br>
                                <br>
                                </div>
                            <!-- <input type="submit" value="No Question Applicable - SKIP" id="skip" onclick="submit()"/> -->
                        </div>
                    </div>
                </div>
                <br/>
                <!-- <input type="button" name="another-question" value="+" id="another-question" onclick="createQuestion()"/> -->
                <!-- <input type="button" value="Submit" onclick="submitFakeForm()" id="submit-button"/> -->
                <!-- <input type="submit" name="submit" value="Submit" id="submit"/> -->
                <!-- <crowd-button>
                    <iron-icon type="submit" id="submit" name="submit" value="Submit" icon="submit"/>
                </crowd-button> -->
                <crowd-button form-action="submit" variant="primary" data-testid="crowd-submit" name="submit" id="submit" disabled="false">Submit</crowd-button>
            </div>
        </form>
    </crowd-form>
    </div>
</section>

<script>

COLORS = [[255-76, 255-175, 255-80], [255-106, 255-90, 255-205], [255-255, 255-165, 255-0], [255-60, 255-179, 255-113], [255-238, 255-130, 255-238], [255-71, 255-41, 255-38]] // color for each span
COLORS_EXIST = [] // COLORS_EXIST[color_index][word_index]
RGB_TEXT = [] // RGB_TEXT[word_index][rgb_value_index]
OPACITY = 0.3


function checkLikert(scaleNum, score){
    if (score <= 2){
        removeColorByIndex(scaleNum - 1);
        const text = document.getElementById("text");
        text.innerHTML = colorSpans(sentence, index).join(' ');
    }
    if (score >= 3){
        addColorByIndex(scaleNum - 1);
        const text = document.getElementById("text");
        text.innerHTML = colorSpans(sentence, index).join(' ');
    }
    submitButton = document.getElementById("submit");
    submitButton.disabled = isSubmitDisabled();
}

function isSubmitDisabled(){
    qa_num = questions.length;
    for (let i = 1; i <= qa_num; i++){
        var curr_likert = document.getElementById("likert-" + i).childNodes[3];
        var list = curr_likert.children;
        var one_checked = false;
        var is_disabled = false;
        for (let i=0; i<list.length; i++ ){
            one_checked = list[i].children[0].checked || one_checked;
            is_disabled = list[i].children[0].disabled;
        }
        if (!one_checked && !is_disabled){
            return true;
            }
    }
    return false;
}

function getQuestionTemplate(questionNum){
    var questionTemplate = `<h4>QA `+questionNum+`</h4>
                            <h5 id="question-` + questionNum + `" class="flex">
                                $question`+ questionNum + `$
                            </h5>`
    return document.createRange().createContextualFragment(questionTemplate);
}

function getAnswerTemplate(answerNum){
    var answerTemplate = `<h5 id="answer-` + answerNum + `" class="flex">
                                $answer`+ answerNum + `$
                            </h5>
                            <br/>
                            <br/>
                            <br/>
                            <br/>`
    return document.createRange().createContextualFragment(answerTemplate);
}

function getLikertScale(scaleNum){
    var likertScale =           `<div id="likert-`+scaleNum+`"
                                <form action="">
                                  <label class="statement">QA `+ scaleNum +`</label>
                                  <ul class='likert'>
                                    <li>
                                      <input type="radio" name="likert`+scaleNum+`" value="1" onclick="checkLikert(`+scaleNum+`, `+ 1 +`)">
                                      <label class="class1">1<br/>Not valid</label>
                                    </li>
                                    <li>
                                      <input type="radio" name="likert`+scaleNum+`" value="2" onclick="checkLikert(`+scaleNum+`, `+ 2 +`)">
                                      <label class="class2">2</label>
                                    </li>
                                    <!--<svg height="100" width="10">-->
                                    <!--<line x1="0" y1="-30" x2="0" y2="70" style="stroke:rgb(239,239,239);stroke-width:7" />-->
                                    <!--<svg />-->
                                    <li>
                                      <input type="radio" name="likert`+scaleNum+`" value="3" onclick="checkLikert(`+scaleNum+`, `+ 3 +`)">
                                      <label class="class3">3</label>
                                    </li>
                                    <li>
                                      <input type="radio" name="likert`+scaleNum+`" value="4" onclick="checkLikert(`+scaleNum+`, `+ 4 +`)">
                                      <label class="class4">4<br/>Very Good</label>
                                    </li>
                                  </ul>
                                </form>
                            </div>`

    return document.createRange().createContextualFragment(likertScale);
}

function getRedundentButton(buttonNum){
    var button = `<div class="buttons">
                <input type="button" id="button-`+ buttonNum +`" class="clear" onClick="onClickRedundantButton(`+buttonNum+`)" value="Redundant"/>
                </div>`
    return document.createRange().createContextualFragment(button);
}

function onClickRedundantButton(buttonNum){
    var currLikertScale = document.getElementById("likert-"+buttonNum).childNodes[3];
    var list = currLikertScale.children;
    var isDisabled = !list[0].children[0].disabled;
    for (let i=0; i<list.length; i++ ){
        list[i].children[0].disabled = !list[i].children[0].disabled;
    }
    var currButton = currLikertScale = document.getElementById("button-"+buttonNum);
    if (isDisabled){
        removeColorByIndex(buttonNum - 1);
        const text = document.getElementById("text");
        text.innerHTML = colorSpans(sentence, index).join(' ');
        for (let i=0; i<list.length; i++ ){
            list[i].children[0].checked = false;
            list[i].children[1].style.color = "#efefef"
        }
        currButton.value = "Undo";
    }
    else{
        addColorByIndex(buttonNum - 1);
        const text = document.getElementById("text");
        text.innerHTML = colorSpans(sentence, index).join(' ');
        list[0].children[1].style.color = "#e05151";
        list[1].children[1].style.color = "#e9b0b0";
        list[2].children[1].style.color = "#a3c0a9";
        list[3].children[1].style.color = "#4faf62";
        currButton.value = "Redundant";
    }
    checkLikert();
}

function addAllQAs(){
    const body = document.getElementById("body");
    const wrap = document.getElementById("wrap");
    for (let i=0; i<questions.length; i++)
    {
        let questionTemplate = getQuestionTemplate(i+1);
        let answerTemplate = getAnswerTemplate(i+1);
        body.appendChild(questionTemplate);
        body.appendChild(answerTemplate);
        wrap.appendChild(getRedundentButton(i+1));
        wrap.appendChild(getLikertScale(i+1));
        let currQuestion = document.getElementById("question-"+ (i+1));
        let currAnswer = document.getElementById("answer-"+ (i+1));
        currQuestion.innerHTML = currQuestion.innerHTML.replace(`$question`+ (i+1) + `$`, `<strong>Q:&nbsp</strong>` + questions[i]);
        currAnswer.innerHTML = currAnswer.innerHTML.replace(`$answer`+ (i+1) + `$`, `<strong>A:&nbsp</strong>` + answers[i]);
    } 
}

function processText(text, index) {
    let processedSentenceParts = text.split(' ');
    for (let i of [index]) {
        processedSentenceParts[i] = '<strong><font size="6">' + processedSentenceParts[i] + '</font></strong>'
        // processedSentenceParts[i] = '<mark>' + processedSentenceParts[i] + '</mark>'
    }
    return processedSentenceParts
}

function initializeColorsExistAndRGBText(text, index){
    curr_text = processText(text, index);
    for (let i=0; i<COLORS.length; i++){
        COLORS_EXIST.push([])
        for (let j=0; j<curr_text.length; j++){
            COLORS_EXIST[i].push(false);
        }
    }
    for (let k=0; k<curr_text.length; k++){
        RGB_TEXT.push([]);
        RGB_TEXT[k].push(255);
        RGB_TEXT[k].push(255);
        RGB_TEXT[k].push(255);
    }
}

function updateColorsExistAndRGBText(numSpans){
    for (let i=0; i<numSpans; i++){
        addColorByIndex(i);
    }
}

function addColorByIndex(spanIndex){
    start = answer_indiced[spanIndex][0] - 1
    end = answer_indiced[spanIndex][1] - 1
    for (let i=start; i<=end; i++)
    {
        if (!COLORS_EXIST[spanIndex][i]){
            COLORS_EXIST[spanIndex][i] = true;
            RGB_TEXT[i][0] -= COLORS[spanIndex][0]
            RGB_TEXT[i][1] -= COLORS[spanIndex][1]
            RGB_TEXT[i][2] -= COLORS[spanIndex][2]
        }
    }
}

function removeColorByIndex(spanIndex){
    start = answer_indiced[spanIndex][0] - 1
    end = answer_indiced[spanIndex][1] - 1
    for (let i=start; i<=end; i++)
    {
        if (COLORS_EXIST[spanIndex][i]){
            COLORS_EXIST[spanIndex][i] = false;
            RGB_TEXT[i][0] += COLORS[spanIndex][0]
            RGB_TEXT[i][1] += COLORS[spanIndex][1]
            RGB_TEXT[i][2] += COLORS[spanIndex][2]
        }
    }
}

function colorSpans(text, index){
    curr_text = processText(text, index);
    // for (let i=0; i<questions.length; i++){
    //     // console.log(curr_text[answer_indiced[i][0] - 1])
    //     start = answer_indiced[i][0] - 1
    //     end = answer_indiced[i][1] - 1
    //     for (j = start; j<=end; j++) {
    //         curr_text[j] = `<span style="background-color:${COLORS[i]};">` + curr_text[j] + '</span>';
    //     }
    //     // curr_text[answer_indiced[i][0] - 1] = `<span style="background-color:${COLORS[i]};">` + curr_text[answer_indiced[i][0] - 1];
    //     // curr_text[answer_indiced[i][1] - 1] = curr_text[answer_indiced[i][1] - 1] + '</span>';
    // }
    for (let i=0; i<questions.length; i++){
        start = answer_indiced[i][0] - 1;
        end = answer_indiced[i][1] - 1;
        for (j = start; j<=end; j++) {
            if (!curr_text[j].includes("<span"))
                curr_text[j] = `<span style="background-color:rgba(` + RGB_TEXT[j][0] + `, ` + RGB_TEXT[j][1] + `, ` + RGB_TEXT[j][2] + `, `+ OPACITY + `);">` + curr_text[j] + '</span>';
        }
    }
    return curr_text
}

</script>

<script>
    // const sentence = "A nonexecutive director of this British conglomerate.";
    // const index = 2;
    // const questions = ["Which organization does the director belong to?", "What kind of director?"]
    // const answers = ['this British conglomerate', 'nonexecutive']
    // const answer_indiced = [[4, 7], [2, 5]]

    const sentence = "${sentence}";
    const index = Number("${index}");
    const questions = "${questions}".split('&');
    const answers = "${answers}".split('&');
    answer_ranges = "${ranges}".split('&')
    answer_indiced = []
    for (let i=0; i<answer_ranges.length; i++){
        answer_indiced.push(answer_ranges[i].split('##'))
    } 


    const text = document.getElementById("text");
    text.innerHTML = text.innerHTML.replace("$sentence$", processText(sentence, index).join(' '));
    initializeColorsExistAndRGBText(sentence, index)
    updateColorsExistAndRGBText(answer_indiced.length)
    addAllQAs();
    text.innerHTML = colorSpans(sentence, index).join(' ');
</script>